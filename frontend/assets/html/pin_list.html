<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="keywords" content="HTML5 Template" />
    <meta
      name="description"
      content="Webster - Responsive Multi-purpose HTML5 Template"
    />
    <meta name="author" content="potenzaglobalsolutions.com" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1"
    />
    <title>FavSpot - Pin Contents</title>

    <!-- Favicon -->
    <link
      rel="shortcut icon"
      href="https://favspot-fin.s3.amazonaws.com/images/default/favicon.png"
    />

    <!-- font -->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Montserrat:300,300i,400,500,500i,600,700,800,900|Poppins:200,300,300i,400,400i,500,500i,600,600i,700,700i,800,800i,900"
    />

    <!-- Plugins -->
    <link
      rel="stylesheet"
      type="text/css"
      href="../css/template/plugins-css.css"
    />

    <!-- Typography -->
    <link
      rel="stylesheet"
      type="text/css"
      href="../css/template/typography.css"
    />

    <!-- Shortcodes -->
    <link
      rel="stylesheet"
      type="text/css"
      href="../css/template/shortcodes/shortcodes.css"
    />

    <!-- Style -->
    <link rel="stylesheet" type="text/css" href="../css/template/style.css" />

    <!-- shop -->
    <link href="../css/template/shop.css" rel="stylesheet" type="text/css" />

    <!-- Responsive -->
    <link
      rel="stylesheet"
      type="text/css"
      href="../css/template/responsive.css"
    />
    <link rel="stylesheet" href="../css/pin-list.css" />
    <link rel="stylesheet" href="../css/modal.css" />

    <style>
      .user-info-btn {
        background-color: #f57979;
        border: none;
      }
    </style>
  </head>


  <body>
    <div id="main-container">
      <!--=================================
shop -->

      <section class="wishlist-page page-section-ptb" style="height: 98.75%">
        <div class="container">
          <div class="row">
            <div class="col-lg-12 col-md-12">
              <div class="section-title text-center">
                <h6 class="">Edit Your Pin Contents</h6>
                <h2 class="title-effect">Pin Contents</h2>
              </div>

              <div id="main" class="row">
                <div class="col-lg-3">
                  <div class="sidebar-widget">
                    <div class="team team-round full-border">
                      <div class="team-photo">
                        <img
                          id="profileImg"
                          class="img-fluid mx-auto"
                          style="object-fit: cover; width: 215px; height: 215px"
                          src="https://favspot-fin.s3.amazonaws.com/images/default/default_user_clear.png"
                          alt=""
                        />
                      </div>
                      <div class="team-description">
                        <div class="team-info">
                          <h6 id="email"></h6>
                          <span id="nickname"></span>
                        </div>
                        <div>
                          <i class="fa fa-user"></i>
                          <a id="followers" href="#">
                            <span
                              class="followers"
                              class="fw-bold small"
                            ></span>
                            <span class="small">followers</span>
                          </a>
                          <span>|</span>
                          <a id="following" href="#">
                            <span
                              class="following"
                              class="fw-bold small"
                            ></span>
                            <span class="small">following</span>
                          </a>
                        </div>
                        <div class="changeBtn"></div>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- ë¦¬ìŠ¤íŠ¸ -->
                <div
                  class="table-responsive col-lg-9"
                  style="padding-bottom: 140px"
                >
                  <h3 class="mb-10" style="font-size: 20px">
                    ğŸ©¹ í•€ ì½”ë©˜íŠ¸ ìˆ˜ì •
                  </h3>
                  <p style="font-size: 16px">
                    ì €ì¥í•œ í•€ì— ëŒ€í•´ ì‘ì„±í•œ ì½”ë©˜íŠ¸ë¥¼ ìˆ˜ì •í•˜ê±°ë‚˜ ì‚­ì œí•  ìˆ˜
                    ìˆìŠµë‹ˆë‹¤.<br />í•€ ì œëª©ì„ í´ë¦­í•˜ë©´ í•€ ìƒì„¸ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜
                    ìˆìŠµë‹ˆë‹¤.
                  </p>
                  <table class="table" style="margin-bottom: 80px">
                    <thead>
                      <tr>
                        <th>Pin</th>
                        <th>Image</th>
                        <th>Text</th>
                        <th>Edit</th>
                        <th>Delete</th>
                      </tr>
                    </thead>
                    <tbody id="editList"></tbody>
                  </table>
                  <h3 class="mb-10" style="font-size: 20px">
                    ğŸ“ í•€ ì½”ë©˜íŠ¸ ì‘ì„±
                  </h3>
                  <p style="font-size: 16px">
                    í•€ì„ ì €ì¥í•  ë•Œ ì½”ë©˜íŠ¸ë¥¼ ì‘ì„±í•˜ì§€ ì•Šì•˜ë‹¤ë©´ ì—¬ê¸°ì„œ ì‘ì„±í•  ìˆ˜
                    ìˆìŠµë‹ˆë‹¤.<br />ë§ˆìŒì— ë“¤ì§€ ì•Šì•„ ì‚­ì œí•œ ì½”ë©˜íŠ¸ë„ ë³µêµ¬ì‹œí‚¬ ìˆ˜
                    ìˆìŠµë‹ˆë‹¤.
                  </p>
                  <table class="table">
                    <thead>
                      <tr>
                        <th>Pin</th>
                        <th>Text</th>
                        <th>Write</th>
                      </tr>
                    </thead>
                    <tbody id="deleteList"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
    <!--=================================
shop -->

    <!--=================================
 jquery -->

    <!-- jquery -->
    <script src="../js/template/jquery-3.6.0.min.js"></script>

    <!-- plugins-jquery -->
    <script src="../js/template/plugins-jquery.js"></script>

    <!-- plugin_path -->
    <script>
      var plugin_path = '../js/template/';
    </script>

    <!-- plugins-jquery -->
    <script
      type="text/javascript"
      src="../js/template/slick/slick.min.js"
    ></script>

    <!-- custom -->
    <script src="../js/template/custom.js"></script>
    <script type="module">
      import { createPreloader } from '/frontend/assets/js/util/preloader.js';
      import { createPinDetail } from '/frontend/assets/js/util/pinDetailModal.js';
      import { createHeader } from '/frontend/assets/js/util/header.js';
      import { createFooter } from '/frontend/assets/js/util/footer.js';

      createPreloader();
      createHeader();
      createFooter();
      createPinDetail();
      
    </script>
    <script type="module">
      import { createAddress, createMenu, createPinData, createThumbnailImg } from '/frontend/assets/js/util/getPlaceInfo.js';
      document.addEventListener('DOMContentLoaded', function () {
        const url = 'http://127.0.0.1:8000';
        const tagList = document.getElementById('tagList');

        fetch(`${url}/user/me/`, {
          method: 'GET',
          credentials: 'include',
        })
          .then((response) => response.json())
          .then((data) => {
            const requestUser = data.results.User.email;
            const requestUserPk = data.results.User.id;
            const followingList = data.results.User.following_list;
            const requestUserProfileImg = data.results.User.profile_img;

            if (requestUser) {
              const email = document.querySelector('#headerEmail');
              email.textContent = requestUser;
              if (requestUserProfileImg) {
                const profileImg = document.querySelector('.profileImg');
                profileImg.src = requestUserProfileImg;
                profileImg.style.borderRadius = '50%';
              }
            }

            // ê°€ì ¸ì˜¨ ì‚¬ìš©ì ë°ì´í„°ë¥¼ í¼ í•„ë“œì— ì±„ì›Œì¤ë‹ˆë‹¤.
            console.log(data);
            const email = document.querySelector('#email');
            email.textContent = data['results']['User']['email'];
            const nickname = document.querySelector('#nickname');

            if (data['results']['User']['nickname']) {
              nickname.textContent = data['results']['User']['nickname'];
            } else {
              nickname.textContent = 'None';
            }
            const img = data['results']['User']['profile_img'];
            console.log(img);
            const profileImg = document.getElementById('profileImg');
            if (img) {
              profileImg.src = img;
            }
            console.log('ìœ ì €', data);
            let followers = document.querySelector('.followers');
            followers.textContent = data['results']['User']['followers'];
            followers = document.querySelector('#followers');
            followers.addEventListener('click', (event) => {
              console.log('click');
              window.location.href = `follower.html`;
            });
            let following = document.querySelector('.following');
            following.textContent = data['results']['User']['following'];
            following = document.querySelector('#following');
            following.addEventListener('click', (event) => {
              window.location.href = `following.html`;
            });

            const changeBtnDiv = document.querySelector('.changeBtn');
            const button = document.createElement('a');
            button.type = 'button';
            button.classList.add('btn', 'btn-primary', 'mt-1', 'user-info-btn');
            button.style.display = 'block';
            button.textContent = 'User Info';
            button.setAttribute('href', 'user_info.html');
            changeBtnDiv.appendChild(button);
          })
          .catch((error) => {
            console.error('Failed to retrieve user data.', error);
          });

        // í•€ ì½˜í…ì¸  ëª©ë¡
        fetch(`${url}/pin/comment/`, {
          method: 'GET',
          credentials: 'include',
        })
          .then((response) => response.json())
          .then((data) => {
            // ê°€ì ¸ì˜¨ ì‚¬ìš©ì ë°ì´í„°ë¥¼ í¼ í•„ë“œì— ì±„ì›Œì¤ë‹ˆë‹¤.
            console.log(data[0]);
            const tbody = document.querySelector('#editList');
            const deleteTbody = document.querySelector('#deleteList');

            const pinContents = data;
            pinContents.forEach((data) => {
              const newTableRow = createTableRow(data);

              if (data.is_deleted) {
                deleteTbody.appendChild(newTableRow);
              } else {
                tbody.appendChild(newTableRow);
              }
            });
          })
          .catch((error) => {
            console.error('Failed to retrieve user data.', error);
          });

        function createTableRow(data) {
          const pin_content = data;
          const tableRow = document.createElement('tr');

          // í•€ ì´ë¦„ ì…€ ìƒì„±
          const pinCell = document.createElement('td');
          pinCell.classList.add('description', 'pt-10', 'pb-10', 'pin-cell');
          const pinLink = document.createElement('a');
          pinLink.href = '#';
          pinLink.textContent = data.pin_title;
          pinLink.setAttribute('data-bs-toggle', 'modal');
          pinLink.setAttribute('data-bs-target', '.bd-example-modal-lg');
          pinLink.addEventListener('click', (e) => {
            e.preventDefault();
            displayPinDetail(data.place_id);
          })
          pinCell.appendChild(pinLink);
          tableRow.appendChild(pinCell);

          // ì´ë¯¸ì§€ ì…€ ìƒì„±
          if (data.is_deleted) {} else {
            const imageCell = document.createElement('td');
            imageCell.classList.add('image', 'pt-10', 'pb-10');

            const contentPhoto = document.createElement('img');
            contentPhoto.classList.add('img-fluid');
            contentPhoto.style.width = '75px';
            contentPhoto.style.height = '75px';
            contentPhoto.style.borderRadius = '10%';
            if (data.photo) {
              contentPhoto.src = data.photo;
            } else {
              contentPhoto.src =
                'https://favspot-fin.s3.amazonaws.com/images/default/main_logo.png';
            }
            contentPhoto.alt = '';

            imageCell.appendChild(contentPhoto);
            tableRow.appendChild(imageCell);
          }

          // í…ìŠ¤íŠ¸ ì…€ ìƒì„±
          const textCell = document.createElement('td');
          textCell.classList.add('description', 'pt-10', 'pb-10', 'text-cell');
          const textLink = document.createElement('a');
          textLink.href = '#';
          if (data.is_deleted) {
            textLink.textContent = "ì½”ë©˜íŠ¸ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”";
            textLink.style.color = "grey";
          } else if (data.text) {
            textLink.textContent = data.text;
          } else {
            textLink.textContent = "ì…ë ¥ëœ ì½”ë©˜íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤";
            textLink.style.color = "grey";
          }

          textCell.appendChild(textLink);
          tableRow.appendChild(textCell);

          // ìˆ˜ì • ë²„íŠ¼ ì…€ ìƒì„±
          const editCell = document.createElement('td');
          editCell.classList.add('td-quantity', 'pt-10', 'pb-10');
          if (data.is_deleted) {
          editCell.style.width = '170px';
          }
          const editLink = document.createElement('a');
          editLink.classList.add('button');
          editLink.href = '#';
          if (data.is_deleted) {
            editLink.textContent = 'ì‘ì„±';
          } else {
            editLink.textContent = 'ìˆ˜ì •';
          }

          // ìˆ˜ì • ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
          editLink.addEventListener('click', (e) => {
            e.preventDefault();

            // ê¸°ì¡´ì— ì—´ë ¤ìˆëŠ” í¼ì´ ìˆëŠ” í–‰ì´ ìˆë‹¤ë©´ ì œê±°
            const oldFormRow = document.querySelector('#edit-form-row');
            if (oldFormRow) {
              // í¼ì´ ì´ë¯¸ ì—´ë ¤ ìˆê³ , ê·¸ í–‰ì´ í˜„ì¬ í–‰ ë°”ë¡œ ì•„ë˜ì— ìˆëŠ” ê²½ìš°, í•´ë‹¹ í–‰ì„ ì œê±°
              if (oldFormRow === tableRow.nextSibling) {
                oldFormRow.remove();
                return;
              }

              // ë‹¤ë¥¸ í–‰ì˜ í¼ì´ ì—´ë ¤ ìˆëŠ” ê²½ìš°, ê·¸ í–‰ì„ ì œê±°
              oldFormRow.remove();
            }

            // ìƒˆë¡œìš´ í¼ì„ í¬í•¨í•œ í–‰ì„ ìƒì„±í•˜ê³ , í˜„ì¬ í´ë¦­ëœ ì¤„ ë°”ë¡œ ì•„ë˜ì— ì‚½ì…
            const newFormRow = document.createElement('tr');
            newFormRow.id = 'edit-form-row';
            const newFormCell = document.createElement('td');
            newFormCell.colSpan = tableRow.children.length; // ì „ì²´ ì¹¸ìœ¼ë¡œ í™•ì¥

            const formContainer = createEditForm(data);
            newFormCell.appendChild(formContainer);
            newFormRow.appendChild(newFormCell);

            tableRow.parentNode.insertBefore(newFormRow, tableRow.nextSibling);
          });

          editCell.appendChild(editLink);
          tableRow.appendChild(editCell);

          // ì‚­ì œ ë²„íŠ¼ ì…€ ìƒì„±
          if (data.is_deleted) {} else {
            const deleteCell = document.createElement('td');
            deleteCell.classList.add('td-quantity', 'pt-10', 'pb-10');

            const deleteButton = document.createElement('button');
            deleteButton.className = 'btn btn-danger';
            deleteButton.textContent = 'X';

            /// ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
            deleteButton.addEventListener('click', () => {
              if (confirm('ì´ ì½”ë©˜íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                fetch(`${url}/pin/content/${data.id}/`, {
                  method: 'DELETE',
                  credentials: 'include',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                })
                  .then((response) => {
                    if (response.status === 204) {
                      location.reload();
                    } else if (response.status === 403) {
                      window.alert('ì½”ë©˜íŠ¸ëŠ” ì‘ì„±ìë§Œ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                    }
                  })
                  .catch((error) => {
                    console.error('ì‚­ì œì‹œ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:', error);
                  });
              }
            });

            deleteCell.appendChild(deleteButton);
            tableRow.appendChild(deleteCell);
          }

          return tableRow;
        }

        // í•€ ì½˜í…ì¸  ìˆ˜ì • ì¹¸ ìƒì„±
        function createEditForm(data) {
          const container = document.createElement('div');
          container.id = 'edit-form';

          // ì´ë¯¸ì§€ í”„ë¦¬ë·° ìƒì„±
          const imagePreview = document.createElement('img');
          imagePreview.id = 'imagePreview';
          imagePreview.className = 'img-fluid ml-3';
          imagePreview.style.objectFit = 'cover';
          imagePreview.style.width = '100px';
          imagePreview.style.height = '100px';
          imagePreview.style.borderRadius = '3px';
          if (data.photo) {
            imagePreview.src = data.photo;
          } else {
            imagePreview.src = 'https://favspot-fin.s3.amazonaws.com/images/default/main_logo.png';
          }
          
          // ì´ë¯¸ì§€ í”„ë¦¬ë·°ë¥¼ ì»¨í…Œì´ë„ˆì— ì¶”ê°€
          container.appendChild(imagePreview);

          // ì´ë¯¸ì§€ ì—…ë¡œë“œ í•„ë“œ ìƒì„±
          const imageInput = document.createElement('input');
          imageInput.type = 'file';
          imageInput.id = 'photoUpload';
          container.appendChild(imageInput);

          imageInput.addEventListener('change', function () {
          const selectedImage = imageInput.files[0];

          if (selectedImage) {
            const reader = new FileReader();
            reader.onload = function (event) {
              imagePreview.src = event.target.result;
            };
            reader.readAsDataURL(selectedImage);
          }
        });

          // í…ìŠ¤íŠ¸ ìˆ˜ì • í•„ë“œ ìƒì„±
          const textInput = document.createElement('textarea');
          textInput.id = 'textUpload';
          textInput.className = 'rounded';
          // ë‚´ìš© ë³€ê²½ ì‹œ ìë™ìœ¼ë¡œ ë†’ì´ ì¡°ì ˆ
          textInput.addEventListener('input', autoResize, false);
          function autoResize() {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
          }
          textInput.value = data.text;
          container.appendChild(textInput);

          // ë“±ë¡ ë²„íŠ¼ ì¶”ê°€
          const submitButton = document.createElement('button');
          submitButton.className = 'rounded submitbtn';
          submitButton.textContent = 'ë“±ë¡';
          // ë“±ë¡ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
          submitButton.addEventListener('click', (e) => {
            e.preventDefault();
            // í…ìŠ¤íŠ¸ í•„ë“œ, ì´ë¯¸ì§€ ì—…ë¡œë“œê°€ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸
            if (!textInput.value.trim() && !imageInput.files.length) {
              window.alert('ë¹ˆ ì½”ë©˜íŠ¸ë¥¼ ë“±ë¡í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‚´ìš©ì´ë‚˜ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
              return;
            }
            if (!window.confirm('ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
              return;
            }
            const formData = new FormData();

            if (textInput.value) {
              formData.append('text', textInput.value);
            }
            if (imageInput.files[0]) {
              formData.append('photo', imageInput.files[0]);
            }

            fetch(`${url}/pin/content/${data.id}/`, {
              method: 'PUT',
              body: formData,
              credentials: 'include',
            })
              .then((response) => response.json())
              .then((data) => {
                window.location.reload();
              })
              .catch((error) => console.error(error));
          });

          container.appendChild(submitButton);

          return container;
        }
      });

      /// ë°±ì—”ë“œì—ì„œ í•€ ìƒì„¸ë³´ê¸° ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      function displayPinDetail(place_id) {
        fetch(`http://127.0.0.1:8000/pin/${place_id}/`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          },
        })
          .then((response) => {
            // ì„±ê³µ ìƒíƒœê°€ ì•„ë‹ˆë©´ ì—ëŸ¬ ë©”ì‹œì§€ ì¶œë ¥ í›„ í•¨ìˆ˜ ì¢…ë£Œ
            return response.json();
          })
          .then((data) => {
            // í•€ ìƒì„± ìŠ¤í…ë“¤ ìˆ¨ê¸°ê³  ì´ˆê¸°í™”í•˜ê¸°
            const pinCreationElement = document.getElementById('pinCreationSteps');
            pinCreationElement.style.display = 'none';
            const saveButton = document.getElementById('saveButton');
            saveButton.innerText = 'í•€ ì €ì¥';

            createPlaceInfo(data.results);
          })
          .catch((error) => {
            console.error('Error fetching data:', error);
          });
      }

      function createPlaceInfo(data) {
        // ê°€ì ¸ì˜¨ ë°ì´í„°ë¡œ ìƒì„¸ë³´ê¸° ì •ë³´ í‘œì‹œí•˜ê¸°
        const modalTitleElement = document.getElementById('myModalLabel');
        const modalCategoryElement = document.getElementById('modalCategory');
        const updatedAt = document.querySelector('.updated-at');
        const pinCount = document.querySelector('.pin-count');
        const pagination = document.getElementById('pagination');
        const pinContentsContainer = document.querySelector('#pinContentsContainer');
        pagination.style.display = 'none';
        pinContentsContainer.style.display = 'none';

        const dataPin = data.pin;
        modalTitleElement.textContent = dataPin.title;
        modalCategoryElement.textContent = dataPin.category;
        updatedAt.style.display = 'inline-block';
        pinCount.style.display = 'inline-block';

        createPinData(data, dataPin);
        createAddress(dataPin);
        createMenu(data);
        createThumbnailImg(dataPin);
      }
    </script>
  </body>
</html>
